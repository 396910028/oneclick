# 项目总览与对照说明（给下一位大模型 / 开发者看的说明）

本项目是一个 **XBoard 风格的 IP 代理 / 机场面板**，采用 **前后端分离 + Docker Compose** 的架构。

---

## 1. 整体结构

项目根目录 `c:\wwwroot\index` 关键文件/目录：

- `docker-compose.yml`：一条命令启动全部服务（MySQL + 后端 + 前端）
- `db_example_basic.sql`：数据库初始化脚本（创建库 + 必要表 + 示例套餐；后端实际用到的表均在此）
- `backend/`：Node.js + Express 后端
- `frontend/`：Vue 3 + Vite + Naive UI 前端

### 1.1 Docker 服务说明

`docker-compose.yml` 中定义了 3 个服务：

- `db`：MySQL 8.0
  - 镜像：`mysql:8.0`
  - 端口映射：`3306:3306`
  - 环境变量：
    - `MYSQL_ROOT_PASSWORD=...`（自行配置）
    - `MYSQL_DATABASE=ip_proxy_platform`
  - 数据卷：`db_data`

- `backend`：后端 API 服务
  - 目录：`backend/`
  - 镜像：`index-backend`（由 `backend/Dockerfile` 构建）
  - 端口映射：`3000:3000`
  - 环境变量：来自 `backend/.env.docker`
    - `DB_HOST=db`（通过 docker 内部网络连接 db）
    - `DB_USER=root`
    - `DB_PASSWORD=...`
    - `DB_NAME=ip_proxy_platform`

- `frontend`：前端 Web（开发模式）
  - 目录：`frontend/`
  - 端口映射：`5173:5173`
  - 使用 Vite 开发服务器，代理 `/api` 到 `http://backend:3000`
  - 通过环境变量 `BACKEND_URL` 控制代理目标

启动命令（在项目根目录）：

```bash
docker compose up -d
```

### 1.2 数据库初始化（自动挂载）

`docker-compose.yml` 已将 `db_example_basic.sql` 挂载到 MySQL 的 `/docker-entrypoint-initdb.d/`，因此：

- **首次启动（db_data 为空）**：会自动建库建表并导入示例数据
- **已存在旧数据卷（db_data 非空）**：MySQL 不会重复执行初始化脚本；如需重新初始化，请执行：

```bash
docker compose down -v
docker compose up -d
```

---

## 0. 最近一次对话遗留/未彻底解决的问题（重要）

> 这部分用于记录迭代过程中仍需注意的问题，方便下一位模型/开发者接手排查。

- **oneclick 脚本曾出现 `EOF: command not found`**
  - 原因：`oneclick/ubuntu-singbox-multi-oneclick.sh` 末尾存在孤立 `EOF` 行
  - 现状：已删除该行；若节点机仍报错，请重新拉取最新脚本再运行
- **node-agent 本机调用仍 403（token 校验失败）**
  - 症状：在节点机执行 `curl -H "x-agent-token: TOKEN" http://127.0.0.1:PORT/v1/node-info` 返回 403 HTML
  - 常见原因：systemd unit/脚本产生的 token 末尾存在不可见字符（如 `\r`）、或运行中的 node-agent 仍使用旧版本严格对比逻辑
  - 现状：已将 node-agent token 比较改为 `.strip()`（同时处理环境变量与请求头），并建议重跑最新脚本覆盖 `node-agent.py + panel-node-agent.service`
- **已移除面板侧“推送UUID”**
  - 影响：仅靠面板状态/订阅接口无法做到“旧配置立刻断开”；要实现“机场级强制断网”，必须恢复节点侧机制（例如 connector 定时拉取 allow 列表并应用、或节点侧外部认证/实时鉴权）

停止并清理容器和数据卷：

```bash
docker compose down -v
```

---

## 2. 数据库设计对照（XBoard 风格）

**数据库结构及示例数据**见：`db_example_basic.sql`

当前后端代码实际用到的表（均在 `db_example_basic.sql` 中）：

- `users`：用户账号（注册/登录，含 `role=user/admin`，已增加签到相关字段 `last_signin_at`、`signin_streak`）
- `plans`：订阅套餐（前端套餐列表；脚本内含基础套餐、高级套餐示例，已包含等级 `level` 与共享策略 `is_exclusive`）
  - **套餐模型变更**：套餐改为单一价格 `price` + 持续时间 `duration_days`（天），不再区分月/季/年付；移除 `reset_traffic_cycle`（流量为一次性配额，无重置周期）
- `orders`：订单（用户购买记录，用于按 `paid_at + duration_days` 叠加计算套餐有效期/剩余价值）
  - **订单模型变更**：订单字段从 `period`（month/quarter/year）改为 `duration_days`（天，创建时从套餐快照写入）
- `tickets`：工单
- `ticket_replies`：工单回复
- 其他扩展表（节点/订阅/签到等）见文档后续章节说明

> 初始化时**执行 `db_example_basic.sql`** 即可完成建库、建表并插入示例套餐。

---

## 3. 后端（backend）说明

### 3.1 技术栈

- Node.js + Express
- MySQL（使用 `mysql2/promise`）
- JWT（身份认证）
- bcryptjs（密码哈希）

入口文件：`backend/src/app.js`

关键模块：

- `src/config/db.js`：MySQL 连接池（基于 `.env.docker` 或 `.env`）
- `src/middleware/auth.js`：JWT 登录校验中间件
- `src/middleware/admin.js`：管理员权限校验中间件
- `src/routes/auth.js`：认证相关接口
- `src/routes/products.js`：**已改造成 `plans` 套餐接口**（见下方说明）
- `src/routes/orders.js`：订单接口（基于 `plans`）
- `src/routes/tickets.js`：工单接口
- `src/routes/admin.js`：管理员后台接口（用户/套餐/订单/工单管理）

### 3.2 实际路由挂载

在 `app.js` 中挂载的路径：

- `/api/health`：健康检查
- `/api/auth`：认证
- `/api/plans`：套餐列表（内部文件为 `routes/products.js`）
- `/api/orders`：订单（含升级预览 `GET /api/orders/:id/upgrade-preview`、升级确认 `POST /api/orders/:id/upgrade-confirm`）
- `/api/tickets`：工单
- `/api/admin`：管理员后台（如 `/api/admin/users`、`/api/admin/plans` 等）

**注意**：为了节省改动，套餐路由文件仍然叫 `products.js`，但在 `app.js` 中以 `plans` 的路径挂载：

```js
const authRoutes = require('./routes/auth');
// 实际为 plans 接口
const planRoutes = require('./routes/products');
const orderRoutes = require('./routes/orders');
const ticketRoutes = require('./routes/tickets');

app.use('/api/auth', authRoutes);
app.use('/api/plans', planRoutes);
app.use('/api/orders', orderRoutes);
app.use('/api/tickets', ticketRoutes);
```

### 3.3 API 详细说明

详见：`backend/API-接口说明.md`  
该文件对以下接口做了清晰对照：

- `/api/auth/register` / `/api/auth/login`
- `/api/plans` / `/api/plans/:id`
- `/api/orders`（GET/POST）
- `/api/orders/:id/upgrade-preview`（GET，升级预览：计算旧套餐残值、新套餐价格、需补金额）
- `/api/orders/:id/upgrade-confirm`（POST，确认升级：创建升级订单）
- `/api/tickets` / `/api/tickets/:id` / `/api/tickets/:id/reply`
- `/api/admin/users` / `/api/admin/plans` / `/api/admin/orders` / `/api/admin/tickets`
- `/api/health`

所有接口都使用统一响应格式：

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

错误/未登录时分别返回对应的 `code` 和 HTTP 状态码（如 400、401、500）。

---

## 4. 前端（frontend）说明

### 4.1 技术栈

- Vue 3 + Vite
- Naive UI（暗色主题）
- Pinia（状态管理）
- Vue Router 4
- Axios

入口：

- `frontend/index.html`
- `frontend/src/main.js`
- `frontend/src/App.vue`

### 4.2 路由与页面

路由定义：`frontend/src/router/index.js`

- 公共（无需登录）：
  - `/auth/login`：登录页
  - `/auth/register`：注册页

- 登录后（主布局 `MainLayout` 内）：
  - `/dashboard`：总览（当前套餐/到期时间/流量占位）
  - `/plans`：套餐列表（调用 `/api/plans`）
  - `/orders`：我的订单（调用 `/api/orders`）
  - `/tickets`：我的工单列表（调用 `/api/tickets`）
  - `/tickets/new`：新建工单（`POST /api/tickets`）
  - `/tickets/:id`：工单详情 + 回复（`GET /api/tickets/:id` + `POST /api/tickets/:id/reply`）
  - `/profile`：个人中心（展示用户基本信息）
  - **管理员仅见**（`user.role === 'admin'` 且在路由守卫中校验 `meta.admin`）：
    - `/admin/users`：用户管理（列表、搜索；操作：启用/停用、升级为管理员/取消管理员、删除用户）
  - `/admin/plans`：套餐管理（列表、新建/编辑/下架；支持设置描述、等级、价格、持续时间（天）、流量/限速等字段）
  - `/admin/orders`：订单管理（列表、按状态/用户筛选；展示支付过期时间；支持「强制支付」「强制取消」）
  - `/admin/tickets`：工单管理（列表、筛选，操作可跳转工单详情回复）

布局与组件：

- `layouts/MainLayout.vue`：XBoard 风格布局（左侧深色菜单 + 顶栏 + 内容区）。**响应式**：视口宽度 &lt; 992px 时侧栏收为左侧抽屉（`n-drawer`），由顶栏汉堡按钮打开/关闭；路由变化时自动关闭抽屉。
- `components/AppHeader.vue`：顶部栏（左侧：站点名；小屏下为 **汉堡按钮「≡」** 打开侧栏。右侧：余额、用户名下拉、角色标签、退出按钮；小屏下紧凑排列并可换行）
- `components/AppSidebar.vue`：侧边菜单（根据 `store/user.js` 的 `user.role`：普通用户包含「工单中心」，管理员在基础菜单中隐藏「工单中心」，并额外增加「用户管理」「套餐管理」「订单管理」「工单管理」四项）
- `components/AppBreadcrumb.vue`：面包屑

状态管理：

- `store/user.js`：保存 `token` + `user`，提供 `isLoggedIn` / `setAuth` / `logout`
- `store/app.js`：侧边栏折叠状态、**响应式状态**（`isMobile`、`drawerVisible`、`gridCols`，依据宽度 768/992px 切换）

API 封装：

- `api/http.js`：Axios 实例，自动附加 `Authorization: Bearer <token>`
- `api/auth.js`：`login` / `register`
- `api/plans.js`：`getPlans` / `getPlanDetail`
- `api/orders.js`：`getOrders` / `createOrder`（管理员下单视为免费，会直接创建已支付金额为 0 的订单）、`getUpgradePreview` / `confirmUpgrade`（套餐升级预览与确认）
- `api/tickets.js`：`getTickets` / `createTicket` / `getTicketDetail` / `replyTicket`
- `api/admin.js`：管理员接口（`getAdminUsers` / `patchAdminUser` / `deleteAdminUser`；`getAdminPlans` / `postAdminPlan` / `putAdminPlan` / `deleteAdminPlan`；`getAdminOrders` / `postAdminOrderForcePay` / `postAdminOrderForceCancel`；`getAdminTickets` / `patchAdminTicket` / `postAdminTicketReply` / `deleteAdminTicket`）

路由守卫：

- 在 `router/index.js` 中暴露 `setupRouterGuards(router)`，在 `main.js` 里调用
- 未登录访问受保护路由时，会重定向到 `/auth/login`
- 访问 `meta.admin === true` 的路由时，若 `user.role !== 'admin'`，会重定向到 `/dashboard`

---

## 5. 外部软件连接容器内 MySQL（重要）

由于 `docker-compose.yml` 中将 MySQL 端口映射为：

```yaml
ports:
  - "3306:3306"
```

所以可以直接在宿主机使用 **MySQL Workbench / DBeaver / 命令行** 连接容器内 MySQL：

- Host：`127.0.0.1`
- Port：`3306`
- User：`root`
- Password：与 `docker-compose.yml` 中 `MYSQL_ROOT_PASSWORD` 一致
- Database：`ip_proxy_platform`

例如命令行：

```bash
mysql -h 127.0.0.1 -P 3306 -u root -p
```

连接后可以执行：

```sql
CREATE DATABASE IF NOT EXISTS ip_proxy_platform
  DEFAULT CHARACTER SET utf8mb4
  DEFAULT COLLATE utf8mb4_unicode_ci;

USE ip_proxy_platform;

-- 然后执行 db_example_basic.sql

---

## 6. 操作记录（2026-01-28）

### 6.1 时间处理错误修复
- **问题**：订单时间显示错误，UTC时间未正确转换为UTC+8时间
- **修复**：
  1. 修改后端订单路由，使用 `UTC_TIMESTAMP()` 替代 `NOW()` 存储UTC时间
  2. 修改前端时间处理工具文件 `utils/datetime.js`，确保正确转换UTC时间到UTC+8时间

### 6.2 管理员不能停用自己账号修复
- **问题**：管理员可以停用自己的账号，导致无法登录
- **修复**：修改前端管理员用户页面 `admin/AdminUsers.vue`，禁用管理员停用自己账号的按钮

### 6.3 账户被封禁提示修复
- **问题**：账户被封禁时直接跳转到登录页，没有提示信息
- **修复**：修改前端http请求拦截器 `api/http.js`，在账户被封禁时先显示提示信息，再跳转到登录页

### 6.4 套餐管理添加上架按钮
- **问题**：套餐管理只有下架按钮，没有上架按钮
- **修复**：修改前端套餐管理页面 `admin/AdminPlans.vue`，根据套餐状态显示上架或下架按钮

### 6.5 取消管理员权限跳转修复
- **问题**：管理员取消自己的管理员权限后报错，没有跳转到普通用户页面
- **修复**：修改前端管理员用户页面 `admin/AdminUsers.vue`，在取消自己的管理员权限后更新用户角色并跳转到普通用户页面

### 6.6 普通用户已解决工单回复限制
- **问题**：普通用户可以在已解决的工单中回复
- **修复**：修改前端工单详情页面 `tickets/TicketDetail.vue`，限制普通用户在已解决的工单中不能回复
```

---

## 6. 目前实际依赖的数据库对象（对照后端代码）

### 6.1 `auth.js`（注册 / 登录）

- 依赖表：`users`
- 关键字段：
  - `id`
  - `username`
  - `email`
  - `password_hash`
  - `status`
  - `role`
  - `last_login_at`

### 6.2 `routes/products.js`（实际为 `plans` 接口）

- 依赖表：`plans`
- 关键字段：
  - `id`
  - `name`
  - `description`
  - `month_price` / `quarter_price` / `year_price`
  - `traffic_limit`
  - `speed_limit`
  - `connections`
  - `reset_traffic_cycle`
  - `is_public`
  - `status`

### 6.3 `routes/orders.js`

- 依赖表：`orders` + `plans`
- 关键字段：
  - `orders.user_id`
  - `orders.plan_id`
  - `orders.order_no`
  - `orders.amount`
  - `orders.pay_method`
  - `orders.status`
  - `orders.period`
  - `orders.created_at` / `paid_at`
  - `plans.name` 作为 `plan_name`

### 6.4 `routes/tickets.js`

- 依赖表：`tickets` + `ticket_replies`
- 关键字段：
  - `tickets.user_id`
  - `tickets.ticket_no`
  - `tickets.title`
  - `tickets.content`
  - `tickets.category`
  - `tickets.status`
  - `tickets.priority`
  - `tickets.created_at` / `updated_at`
  - `ticket_replies.ticket_id`
  - `ticket_replies.user_id`
  - `ticket_replies.is_admin`
  - `ticket_replies.content`
  - `ticket_replies.created_at`

### 6.5 `routes/admin.js`（管理员后台）

- 依赖表：
  - `users`：用户列表与修改（状态/角色/余额/到期时间）
  - `plans`：套餐增删改查
  - `orders` + `users` + `plans`：后台订单查询
  - `tickets` + `ticket_replies`：工单列表、状态调整与管理员回复
- 所有路由使用 `auth` + `adminOnly` 中间件，要求 `users.role = 'admin'`

---

## 7. 初始化流程总结（从零到可用）

给下一位模型 / 开发者的快速步骤：

1. **确保本机已安装**：Docker Desktop（并可访问 Docker Hub 或镜像源）
2. 克隆/打开本项目目录 `c:\wwwroot\index`
3. 配置 `docker-compose.yml` 和 `backend/.env.docker` 中的 MySQL root 密码（保持一致）
4. 启动所有服务：

   ```bash
   docker compose up -d
   ```

5. 使用外部 MySQL 客户端（或 `docker exec -it ip_proxy_db mysql`）执行：

   ```sql
   SOURCE 路径/到/db_example_basic.sql;
   ```

6. 浏览器访问：
   - 后端健康检查：`http://localhost:3000/api/health`
   - 前端登录页：`http://localhost:5173/auth/login`

7. 前端操作路径：
   - `/auth/register` 注册新用户
   - `/auth/login` 登录
   - `/plans` 查看套餐并创建订单
   - `/orders` 查看订单列表
   - `/tickets` / `/tickets/new` / `/tickets/:id` 提交与查看工单

到此，整个系统前后端 + 数据库 + Docker 环境即可正常运转。

---

## 8. Docker 构建报错排查

### 8.1 去掉 version 警告

`docker-compose.yml` 已移除顶部的 `version: "3.9"`（新版 Compose 会忽略该字段，去掉可避免警告）。

### 8.2 报错：`parent snapshot ... does not exist: not found`

这是 **Docker BuildKit 构建缓存损坏**导致的（例如后端镜像导出时提示 parent snapshot 不存在）。

**处理步骤（在项目根目录执行）：**

1. 清理构建缓存：
   ```bash
   docker builder prune -f
   ```

2. 无缓存重新构建并启动：
   ```bash
   docker compose build --no-cache
   docker compose up -d
   ```
   或一条命令：
   ```bash
   docker compose up --build --no-cache -d
   ```

3. 若仍失败，可先删除旧镜像再构建：
   ```bash
   docker rmi index-backend index-frontend 2>nul
   docker compose build --no-cache
   docker compose up -d
   ```

---

## 9. 新增/修改记录（供下一位大模型对照）

以下为在既有方案上**新增或修改**的部分，便于后续模型或开发者一一对照。

### 9.1 后端

- **`backend/src/middleware/admin.js`**（新增）：管理员权限中间件，校验 `req.user.role === 'admin'`，否则返回 403。
- **`backend/src/middleware/auth.js`**（修改）：除了校验 JWT 外，每次请求都会查询 `users` 表，确保用户仍存在且 `status != 'banned'`，从而保证停用/封禁能**立即生效**；`req.user` 中的 `role/status` 始终与数据库保持同步。
- **`backend/src/routes/admin.js`**（新增 + 修改）：管理员路由，挂载在 `/api/admin`，包含用户、套餐、订单、工单、节点的查询/修改/回复等：
  - 用户：
    - **PATCH /api/admin/users/:id**：支持更新 `status`、`role`、`balance`、`expired_at`、**`traffic_total`**（流量限制，字节）、**`traffic_used`**（已用流量，字节），用于管理员在面板中设置用户流量限制和到期时间，实现流量控制和到期断网。
    - 增加 **DELETE /api/admin/users/:id**（删除用户，禁止删除自己，订单/工单级联删除），同时禁止管理员将**当前登录账号**设置为 `banned`。
  - 工单：
    - **GET /api/admin/tickets**：返回时包含一个 `due_at` 字段：当 `status` 为 `open`/`in_progress` 时为 `updated_at + 1 天`，否则为 `NULL`，列表按状态优先级排序：open → in_progress → resolved → 其它，再按创建时间升序。
    - **POST /api/admin/tickets/:id/reply**：插入管理员回复时，要求前端在请求体中显式传入 `status` 为 `resolved`（已解决）或 `open`（待用户补充），并据此更新工单状态、`admin_id`、`updated_at` 以及必要时的 `resolved_at`。
  - **节点管理**（新增）：
    - **GET /api/admin/nodes**：列出所有节点及其绑定的套餐ID（通过 `LEFT JOIN plan_nodes` 和 `GROUP_CONCAT` 汇总）。
    - **POST /api/admin/nodes**：新增节点（可同时绑定套餐），使用事务确保节点和 `plan_nodes` 关系同时写入；批量插入 `plan_nodes` 时使用 `(?, ?, ?)` 占位符，`created_at` 依赖表默认值，避免列数不匹配错误。
    - **PUT /api/admin/nodes/:id**：更新节点信息（可同时更新绑定套餐），先删除旧关系再插入新关系。
    - **DELETE /api/admin/nodes/:id**：删除节点（同时删除 `plan_nodes` 中的绑定关系）。
- **`backend/src/routes/tickets.js`**（修改）：
  - 普通用户：逻辑不变，仍只能访问自己的工单。
  - 管理员：`GET /api/tickets/:id` 可以查看任意工单详情 + 回复。
  - 用户使用 `POST /api/tickets/:id/reply` 追加回复时，会自动把工单状态重新置为 `open`（待处理），并更新 `updated_at`。
- **`backend/src/routes/admin.js`（订单部分）**：`AdminOrders` 相关接口维持原有逻辑，`pay_expire_at` 由 `created_at + 30 分钟` 计算，用于前后台统一展示支付剩余时间。
- **`backend/src/app.js`**（修改）：增加 `app.use('/api/admin', adminRoutes)` 和 `app.use('/api/subscription', subscriptionRoutes)`、`app.use('/api/sub', subscriptionRoutes)`（订阅链接访问路径）。
- **`backend/src/routes/auth.js`**（修改）：新增 **GET /api/auth/me** 接口，返回当前登录用户的详细信息（含 `traffic_total`、`traffic_used`、`expired_at`、`balance` 等），供前端总览页和个人中心展示流量使用情况。
  - **重要修复（登录 500 / 后端无法启动）**：新增 `/me` 路由时必须 `require('../middleware/auth')` 并使用 `authMiddleware`；此前漏引入会导致后端启动时报错 `ReferenceError: authMiddleware is not defined`（日志指向 `/app/src/routes/auth.js:141`），进而表现为前端可打开但登录接口 500。已在 `auth.js` 顶部补上 `const authMiddleware = require('../middleware/auth');`。
- **`backend/src/routes/subscription.js`**（新增）：订阅管理路由，包含：
  - **GET /api/subscription/token**：获取或生成用户的订阅 token（首次访问自动生成，后续返回已有 token）。
  - **POST /api/subscription/reset-token**：重置订阅 token（旧链接失效）。
  - **GET /api/sub/:token?format=clash**：获取订阅内容，支持多种格式（`format` 参数：`clash`、`v2ray`、`sing-box`、`surge`、`quantumult`）。订阅接口会校验用户状态（active/banned）、到期时间、流量限制，并根据用户当前已支付订单的套餐查询可用节点（通过 `plan_nodes` 关联），生成对应格式的订阅配置。支持的节点协议：VLESS（含 Reality）、VMess、Shadowsocks、Trojan、Hysteria2。
  - **V2Ray 订阅格式**：返回纯文本多行链接（每行一个 `vmess://` / `vless://` / `ss://` / `trojan://` / `hysteria2://` 链接），不再整体 Base64 编码，V2RayN/V2RayNG 可直接识别。
  - **SQL 修复**：查询用户可用节点时使用 `SELECT DISTINCT pn.node_id`，移除 `ORDER BY` 子句以避免 MySQL ONLY_FULL_GROUP_BY 模式下的错误（节点顺序不影响订阅功能）。
- **`backend/API-接口说明.md`**（修改）：已补充第六章「管理员后台接口」以及工单状态流转的行为说明。

### 9.2 前端

- **`frontend/vite.config.js`**（修改）：`/api` 代理目标改为优先读取 `process.env.BACKEND_URL`：
  - 在 Docker 中通过 `BACKEND_URL=http://backend:3000` 代理到后端容器；
  - 本地开发时无该变量则回退为 `http://localhost:3000`。
- **`frontend/src/utils/datetime.js`**（新增）：时间工具 `formatDateTimeUtc8(value)`，统一将时间按本地时区格式化为形如 `2026年1月28日23:07:52` 的字符串（`YYYY年M月D日HH:mm:ss`），在部署于 UTC+8 环境时可直接满足展示需求。
- **时间展示统一调整**（所有与时间相关的页面已改用 `formatDateTimeUtc8`）：
  - `OrdersList.vue`：用户「我的订单」中的 `created_at`、`paid_at` 统一按 UTC+8 显示为中文年月日时分秒。
  - `Dashboard.vue`：总览页当前套餐的 `expire_at` 使用 UTC+8 格式展示。
  - `TicketsList.vue`：用户「我的工单」列表的 `创建时间` 列统一为 UTC+8 中文时间。
  - `TicketDetail.vue`：工单详情页时间轴中每条回复的时间显示为格式化后的 UTC+8 文本。
  - `AdminUsers.vue`：管理员用户管理中的「注册时间」列统一使用 UTC+8 格式。
  - `AdminOrders.vue`：管理员订单管理中的「创建时间」「支付过期时间」列统一使用 UTC+8 格式。
  - `AdminTickets.vue`：管理员工单管理中的「创建时间」「到期时间」列统一使用 UTC+8 格式。
- **`frontend/src/api/admin.js`**（新增）：封装 `/api/admin/*` 的请求（用户、套餐、订单、工单），工单包含 `deleteAdminTicket(id)` 等方法。
- **`frontend/src/router/index.js`**（修改）：
  - 新增路由：`/admin/users`、`/admin/plans`、`/admin/orders`、`/admin/tickets`，对应组件为 `views/admin/Admin*.vue`，`meta: { title, admin: true }`。
  - 路由守卫：若 `to.meta.admin === true` 且 `userStore.user?.role !== 'admin'`，则重定向到 `/dashboard`。
- **`frontend/src/components/AppSidebar.vue`**（修改）：
  - 菜单选项改为根据 `useUserStore().user?.role` 计算：`role === 'admin'` 时在基础菜单后追加「用户管理」「套餐管理」「订单管理」「工单管理」四项（key 为 `/admin/users` 等），并对普通用户隐藏管理员菜单。
- **`frontend/src/components/AppHeader.vue`**（修改）：
  - 顶部右侧展示顺序：余额 → 用户名（下拉，个人中心/退出登录）→ **角色标签**（`user.role === 'admin'` 显示「管理员」橙色标签，否则「用户」）→ **「退出」按钮（置最右）**。
  - **响应式**：小屏（&lt;992px）左侧显示汉堡按钮「≡」打开侧栏抽屉，右侧紧凑排列；超小屏用户名最大宽度限制。
  - 点击「退出」或下拉中的「退出登录」均调用 `userStore.logout()` 并跳转 `/auth/login`。
- **`frontend/src/views/admin/`**（新增目录及四个页面）：
  - `AdminUsers.vue`：用户列表、分页、关键词搜索；操作列：
    - **启用/停用**（`status`，带二次确认；停用后由于 `auth` 中间件每次查库，能立即生效，用户立即无法登录和使用服务，实现「强行断网」）；
    - **编辑**（弹窗表单）：可设置用户流量限制（`traffic_total`，单位 GB，0 表示不限）、已用流量（`traffic_used`，单位 GB，用于重置或手动调整）、到期时间（`expired_at`，到期后订阅接口返回空节点，实现「到期断网」）、账户余额（`balance`）。流量控制和断网通过对接程序读取数据库实现：当 `traffic_used >= traffic_total` 或 `expired_at < now()` 或 `status = 'banned'` 时，对接程序拒绝连接。
    - **升级为管理员/取消管理员**（`role`，均带二次确认，避免误操作；禁止对当前登录管理员执行停用和删除）；
    - **删除**（二次确认，禁止删除当前登录管理员），调用 `getAdminUsers` / `patchAdminUser` / `deleteAdminUser`。
    - 列表展示：用户名、邮箱、角色、状态、余额、**流量使用**（已用/总量 GB + 百分比）、**到期时间**、注册时间。
  - `AdminPlans.vue`：套餐列表、新建/编辑（弹窗表单）、下架；表单支持描述、等级、流量/限速、流量重置周期等字段，调用 get/post/put/delete admin plans。
  - `AdminOrders.vue`：订单列表、分页、按状态/用户ID筛选；展示 `pay_expire_at`（创建时间 +30 分钟），操作列提供「强制支付」「强制取消」，调用 `getAdminOrders` / `postAdminOrderForcePay` / `postAdminOrderForceCancel`。
  - `AdminTickets.vue`：工单列表、分页、按状态筛选；返回的数据中包含 `due_at = updated_at + 1 天` 字段，前端展示为「到期时间」，并按状态优先级（待处理→处理中→已解决→其它）及创建时间排序；操作列「查看/回复」跳转 `/tickets/:id`、「删除」（二次确认后调用 `deleteAdminTicket` 并刷新列表）；管理员可在工单详情页回复。
  - **`AdminNodes.vue`**：节点管理页面，展示 `nodes` 表中的节点列表（名称、地址、端口、协议、状态、绑定套餐等），支持新建/编辑/删除节点，节点配置以 JSON 文本形式保存到 `nodes.config`，并可通过粘贴节点链接一键解析填充基础字段；通过多选框绑定可用套餐（写入/更新 `plan_nodes`）。当前解析器支持的协议前缀包括：`vless://`、`vmess://`、`ss://`（Shadowsocks）、`trojan://`、`hysteria2://` / `hy2://`、`socks://` / `socks5://`、`http://` / `https://` 以及自定义的 `wireguard://` / `wg://`（WireGuard，采用 query 参数描述密钥与 endpoint，解析失败时可手动编辑 JSON）。
  - `AdminNodes.vue`（增强）：新增「一键绑定节点（面板主动连节点）」卡片：
    - 改为粘贴「一键导入码」：脚本输出一行 `SBAGENT1:<base64(json)>`，面板自动解析出 `agent_url/agent_token`（免复制两次）
    - 可选选择 `plan_ids` 作为默认绑定套餐
    - 点击「一键导入到面板」调用 `POST /api/admin/node-agent/import`，自动导入/创建多协议节点并绑定套餐
    - 移除：不再在节点管理页展示/修改 `INTERNAL_API_KEY`（避免混淆；node-agent 模式不需要 INTERNAL_API_KEY）
    - 便捷：支持从 URL 参数自动填充 agent 信息（`/admin/nodes?agent_url=...&agent_token=...&plan_ids=1,2&auto_import=1`）
  - **`Dashboard.vue`**（修改）：总览页新增「订阅链接」卡片，展示 Clash 和 V2Ray 两种常用格式的订阅链接，支持一键复制；提示用户更多格式（sing-box、Surge、Quantumult）可在「个人中心」查看。总览页「当前套餐」卡片只展示套餐名称（不再显示“月付/季付/年付”等周期标签），「剩余流量」卡片显示当前用户的流量使用情况（剩余流量 / 总流量 GB + 已用百分比），当 `traffic_total <= 0` 时不再显示“无限”，而是展示为 `0GB（未分配流量，已用 XGB）`，通过 `GET /api/auth/me` 获取用户详细信息（含 `traffic_total`、`traffic_used`、签到增加的流量等）。
- **`frontend/src/api/user.js`**（新增）：封装用户信息相关 API（`getUserInfo`，调用 `GET /api/auth/me`）。
  - **`Profile.vue`**（修改）：个人中心页面新增「订阅链接」卡片，展示多种格式的订阅链接（Clash、V2Ray、sing-box、Surge、Quantumult），支持一键复制和重置订阅 token；订阅链接格式：`/api/sub/:token?format=clash`（`format` 可选：`clash`、`v2ray`、`sing-box`、`surge`、`quantumult`）。
- **`frontend/src/api/subscription.js`**（新增）：封装订阅相关 API（`getSubscriptionToken`、`resetSubscriptionToken`）。
- **响应式适配（平板/手机）**：
  - **store/app.js**：增加 `isMobile`（宽度&lt;992px）、`drawerVisible`、`gridCols`（&lt;768 为 1 列，&lt;992 为 2 列，否则 3 列）。
  - **MainLayout**：小屏下侧栏改为 `n-drawer`，监听 resize 与路由以更新/关闭抽屉。
  - **AppSidebar**：支持 `collapsedOverride` 属性，抽屉内传入 `false` 以始终展开。
  - **global.css**：`.table-responsive` 包裹表格实现横向滚动；小屏根字号与禁止横向溢出。
  - **列表/表格页**：套餐列表、Dashboard 使用 `appStore.gridCols` 做响应式栅格；所有 `n-data-table` 外包 `table-responsive`。登录/注册页卡片在小屏下 `max-width: calc(100vw - 24px)` 并适配 padding。

### 9.3 数据库与文档

- **`db_example_basic.sql`**（重写/整理）：基于当前后端路由与接口说明重新整理为唯一初始化脚本：
  - 创建数据库 `ip_proxy_platform`；
  - 创建以下基础表，并设置相应外键、索引：
    - `users`：用户账号（含余额、总流量/已用流量、状态、角色、到期时间等）；
    - `plans`：订阅套餐（价格、流量、连接数、是否公开等）；
    - `orders`：订单（用户购买记录）；
    - `tickets` / `ticket_replies`：工单与工单回复；
    - **`nodes`**：节点信息（地址、端口、协议、JSON 配置、启用状态等，协议枚举支持：`vmess`、`vless`、`trojan`、`shadowsocks`、`hysteria2`、`socks`、`http`、`wireguard`）；
    - **`plan_nodes`**：套餐与可用节点的多对多关系（一个套餐可对应多节点、一个节点可挂多套餐，订阅生成时按套餐筛节点）；
    - **`user_clients`**：用户出站凭证（如 VLESS/VMess UUID），供后续对接程序/外部认证按 UUID 鉴权与记账；
    - **`subscriptions`**：用户订阅 token 表（每个用户一个唯一 token，用于生成订阅链接 `/api/sub/:token`）；
    - **`node_connections` / `node_traffic`**：节点连接与按日流量统计（预留给将来对接代理程序做细粒度统计与看板）。
  - 插入两条示例套餐数据（基础/高级，流量字段改为明确的字节数：100GB = 107374182400，300GB = 322122547200）；
  - 文末增加「将某用户提权为管理员」示例：`UPDATE users SET role = 'admin' WHERE id = 1;`。
- **`backend/README-Docker运行后端.md`**（修改）：建表部分改为明确执行 `db_example_basic.sql`，并修正示例接口为 `/api/plans`。
- **`项目总览与对照说明.md`**（本文件）：已按上述所有新增与修改点更新各节内容，并持续在本节记录增量改动。

### 9.4 使用说明（管理员）

- 数据库中需将目标用户的 `users.role` 设为 `admin`（如 `UPDATE users SET role = 'admin' WHERE id = 1;`），之后该用户**必须先退出再重新登录**，前端才会拿到带 `role: 'admin'` 的 token 和 user，侧栏和顶栏才会显示管理员菜单与「管理员」角色标签。
- 管理员在「用户管理」中停用用户（`status = 'banned'`）后，由于 `auth` 中间件每次请求都会查库，**该用户现有所有会话会立即失效**，再次访问任意受保护接口都会得到 403「账户已被停用」。
- 在「工单管理」中：
  - 管理员在回复工单时必须指定处理结果：`resolved`（已解决）或 `open`（待用户补充），状态不会再自动按时间变化；列表中的「到期时间」为当前状态下 `updated_at + 1 天`（仅对 open/in_progress 生效）。
  - 用户在工单中再次追加回复后，状态自动回到 `open`（待处理），方便管理员重新跟进。
- **订阅功能**：
  - 用户在「总览」页可查看 Clash 和 V2Ray 两种常用格式的订阅链接，在「个人中心」可查看全部格式（Clash、V2Ray、sing-box、Surge、Quantumult），订阅链接格式：`/api/sub/:token?format=clash`。
  - V2Ray 订阅格式为纯文本多行链接（每行一个节点链接），V2RayN/V2RayNG 可直接识别，不再整体 Base64 编码。
  - 订阅接口会校验用户状态、到期时间、流量限制，并根据用户当前已支付订单的套餐查询可用节点（通过 `plan_nodes` 关联）。
  - 订阅 token 存储在 `subscriptions` 表中，每个用户首次访问 `/api/subscription/token` 时自动生成，支持重置（重置后旧链接失效）。
- **流量控制和断网机制**：
  - **前端（面板）职责**：管理员在「用户管理」中通过编辑功能设置用户的流量限制（`traffic_total`）、已用流量（`traffic_used`）、到期时间（`expired_at`）、账户状态（`status`），这些操作通过 `PATCH /api/admin/users/:id` 写入数据库。
  - **后端/对接程序职责**：对接程序（Go/Rust 等）通过 `/internal/auth` 接口或直接查询数据库，读取用户的 `status`、`expired_at`、`traffic_total`、`traffic_used`，当 `status = 'banned'` 或 `expired_at < now()` 或 `traffic_used >= traffic_total` 时，拒绝连接，实现「强行断网」和「流量控制」。
  - **订阅接口层面的控制**：`GET /api/sub/:token` 也会校验这些条件，超限/过期/封禁时返回空订阅或错误提示，客户端无法获取节点配置。
  - **总览页展示**：用户可在总览页查看自己的流量使用情况（剩余流量 / 总流量 GB + 已用百分比），通过 `GET /api/auth/me` 获取最新数据。

---

## 10. 精确 UUID 控制（机场级别）——已补齐面板侧能力

> 目标：**即使用户保存了旧订阅/旧配置，只要套餐到期或被封禁/超流量，就必须立刻无法连接**。  
> 关键点：仅靠“订阅接口返回空内容”不够（客户端可以不刷新订阅继续用旧配置），必须在节点侧按 **UUID** 做实时鉴权/同步。

### 10.1 用户 UUID（凭证）来源：`user_clients`

- 表：`user_clients(user_id, uuid, enabled, ...)`
- 规则：每个用户至少 1 个启用中的 UUID（无则自动生成）。

### 10.2 订阅下发改为“用户专属 UUID”

- 文件：`backend/src/routes/subscription.js`
- 变更：
  - 订阅生成时会先 `getOrCreateUserUuid(user_id)`，然后在生成 **VLESS/VMess** 节点时使用该用户 UUID：
    - VLESS：`uuid = userUuid`（兼容旧字段 `config.uuid/config.id`）
    - VMess：`id = userUuid`（兼容旧字段 `config.id/config.v`）
  - 这样节点侧可以用 UUID 精确识别到具体用户，实现按用户维度封禁/到期/流量控制。

### 10.3 订单式到期：订阅可用性不再依赖 `users.expired_at`

- 文件：`backend/src/routes/subscription.js`
- 变更：订阅判断“是否过期”改为：
  - 查询用户全部 `status='paid'` 订单；
  - 按 `plan_id` 分组，按 `period(month/quarter/year)` 做**周期叠加**计算每个套餐的实际到期时间；
  - 只保留 **仍未到期** 的套餐对应节点（通过 `plan_nodes` 取节点）。
- 结果：**即使用户还有订阅 token，只要订单式套餐到期，订阅接口会直接返回 `# 订阅已过期`，无法再获取节点。**

### 10.4 节点侧对接（Internal API）：用于“强行断网/同步 UUID/记账”

- 文件：`backend/src/routes/internal.js`（新增）并在 `backend/src/app.js` 挂载：
  - `GET /api/internal/auth?uuid=...&node_id=...`
    - Header：`x-internal-token: <INTERNAL_API_KEY>`
    - 返回：`allow/deny + reason`
    - 判定依据：`users.status`、`traffic_total/used`、以及 **订单式有效套餐**；可选校验 `node_id` 是否在允许节点范围内
  - `GET /api/internal/nodes/:nodeId/allowed-uuids`
    - 用于对接程序周期性拉取“允许 UUID 列表”，然后调用 Xray 的 add/remove user（或重载配置）来做到期/封禁**立即断网**
  - `POST /api/internal/report-traffic`
    - body：`{ uuid, node_id, upload, download }`
    - 用于对接程序上报流量：累加 `users.traffic_used` 并按日写入 `node_traffic`
  - `POST /api/internal/register-node`
    - body：`{ name, address, port, protocol, config, status?, sort_order?, plan_ids? }`
    - 用途：给“新机器一键开局脚本”使用，把节点信息一键写入面板 `nodes`（按 `address+port+protocol` 幂等 upsert）；可选同步绑定套餐（写入 `plan_nodes`）。

### 10.5 内部接口密钥配置

- 文件：`backend/.env.docker`
- 新增：`INTERNAL_API_KEY=...`
- 所有 `/api/internal/*` 请求必须带请求头：`x-internal-token` 与该值匹配。

### 10.10 面板主动连节点（被控端方案：node-agent）

> 解决“面板只在本地跑，公网节点机无法访问面板”的场景：  
> 让节点机启动 `node-agent`，由**面板主动连接节点公网 IP** 拉取节点配置并推送允许用户列表。

- 后端新增（管理员接口）：
  - `POST /api/admin/node-agent/import`：面板主动请求 `node-agent /v1/node-info`，自动在面板创建/更新多条节点记录（每协议一条）
  - 错误提示优化：当后端无法连接 agent（超时/拒绝连接/解析失败）时，返回 400 并给出明确原因（避免前端只看到 500）
  - 错误提示增强：当 agent 返回 403 时，后端会明确提示 **agent_token 不正确/不匹配**（不再把 HTML 错误页原样输出）
- 节点侧：
  - `oneclick/ubuntu-singbox-multi-oneclick.sh` 会额外启动 `panel-node-agent.service`
  - node-agent 通过 `x-agent-token` 鉴权

### 10.6 对接程序（connector）示例（Go）

- 目录：`connector/`（新增）
- 作用：周期性拉取面板的“允许 UUID 列表”，并把变更应用到节点核心，实现 **到期/封禁/超流量的强行断网**；后续扩展为同时上报真实流量，做到“完整自动记账”。
- 核心调用：
  - `GET /api/internal/nodes/:nodeId/allowed-uuids`（Header：`x-internal-token`）
  - 输出文件：`OUTPUT_DIR/node-<id>/allowed-uuids.{txt,json}`
- 应用方式（两种）：
  - **方式 A：命令钩子（旧方式）**：变更后执行 `APPLY_CMD`（支持 `{node_id}`、`{uuids_file}`、`{uuids_json}` 占位符），你可在脚本里重写配置并重启容器/服务（会有闪断）。
  - **方式 B：Xray gRPC 热更新（新方式，推荐）**：设置 `APPLY_MODE=xray-grpc`，connector 会通过 Xray 的 `HandlerService` 动态 `AddUser/RemoveUser`，**无需重启**。
    - 关键环境变量：
      - `APPLY_MODE=xray-grpc`
      - `XRAY_API_ADDR=127.0.0.1:10085`（Xray gRPC 只建议监听本机）
      - `XRAY_TAG_MAP=16:in-vless-reality,17:in-vmess`（面板 node_id → Xray inbound tag）
      - `XRAY_VLESS_FLOW=xtls-rprx-vision`（VLESS Vision 常用 flow）
    - connector 会额外写入：`OUTPUT_DIR/node-<id>/applied.json`（本机已应用 UUID 集合，供排错/面板工具读取）
- **流量记账扩展（当前进度）**：
  - 面板新增内部接口 `POST /api/internal/report-traffic`，用于接收节点按 UUID 上报“增量流量”（upload+download 字节）：
    - 更新 `users.traffic_used`（总已用流量）
    - 更新 `node_traffic (node_id, date)`（节点当天总流量）
    - 更新 `user_traffic_minute (user_id, ts_minute)`（用户分钟级流量，用于总览图表/近 24 小时查询）
  - 面板新增内部查询接口 `GET /api/internal/user-traffic?uuid=...`：
    - 返回用户总配额/已用流量 + 近 24 小时上传/下载总量，供节点按键面板查询。
  - 规划中：在 connector 中接入 Xray Stats/gRPC，每分钟按 email/UUID 读取真实 uplink/downlink 增量，并自动调用 `/api/internal/report-traffic` 上报给面板。
- 说明：仓库内提供 `connector/README.md`，包含环境变量、运行方式和 apply 脚本接入方式。

### 10.7 流量记账相关数据库结构（node_traffic + user_traffic_minute）

- 文件：`db_example_basic.sql`
- 变更：
  - 为 `node_traffic` 增加唯一键 `UNIQUE(node_id, date)`（`uk_node_traffic_node_date`），以支持对接程序上报流量接口中的 `INSERT ... ON DUPLICATE KEY UPDATE`。
  - 新增表 `user_traffic_minute`（用户分钟级流量统计），字段：
    - `user_id`：用户 ID
    - `ts_minute`：时间粒度（到分钟，例如 `2026-01-29 12:34:00`）
    - `upload` / `download`：该分钟内上行/下行字节数
  - 约束/索引：
    - 外键：`fk_utm_user (user_id) REFERENCES users(id) ON DELETE CASCADE`
    - 唯一键：`uk_utm_user_ts (user_id, ts_minute)`，便于做 `INSERT ... ON DUPLICATE KEY UPDATE`
    - 索引：`idx_utm_user`、`idx_utm_ts`

### 10.8 Ubuntu 新机器一键开局脚本（最小可用版：Xray VLESS+Reality）

- 目录：`oneclick/`（专门放一键开局脚本）
- 脚本：`oneclick/ubuntu-xray-vless-reality-oneclick.sh`
- 能力：
  - 在 Ubuntu 上安装必要依赖（docker / compose / jq）
  - 自动生成 Reality keypair + shortId
  - 启动 Xray（Docker，host network）
  - 调用 `POST /api/internal/register-node` 把节点写入面板
  - 脚本支持**交互式输入**（逐步提示填写面板地址/端口/密钥/节点名等），也支持参数模式（无人值守）。
  - 创建 `panel-connector.service`：定时拉取 `allowed-uuids`，更新 Xray clients 并重启容器，达到“到期/封禁/超流量立即断网”（同步间隔可通过脚本参数 `--interval` 控制）

### 10.9 Ubuntu 新机器一键开局脚本（sing-box 多协议版）

- 脚本：`oneclick/ubuntu-singbox-multi-oneclick.sh`
- 默认启动协议/端口：
  - 默认改为“连续端口段”（起始端口默认 1080，共 6 个端口，便于一次性放行防火墙）：
    - SOCKS5：1080（用户名/密码均为用户 UUID）
    - VLESS Reality：1081（使用 `sni` 伪装握手）
    - VMess TLS：1082（默认自签证书，客户端需开启 `insecure`）
    - Trojan TLS：1083（默认自签证书，客户端需开启 `insecure`）
    - Hysteria2 TLS：1084（默认自签证书，客户端需开启 `insecure`）
    - node-agent：1085（面板主动连节点用）
- 脚本能力：
  - 脚本支持**交互式输入**（逐步提示填写面板地址/端口/密钥/节点名等），也支持参数模式（无人值守）。
  - 自动安装 docker/compose/jq/openssl
  - **兼容 Ubuntu 22.04 常见环境**：若 `apt` 中找不到 `docker-compose-plugin`，脚本会自动添加 Docker 官方 APT 源并安装 compose plugin；若仍失败，再回退到 `docker-compose`（v1）。
  - 自动生成 Reality keypair + shortId
    - 修复：使用 `docker run --entrypoint xray ... x25519` 生成，避免出现 `xray xray: unknown command`
  - 自动生成自签 TLS 证书（VMess/Trojan/Hy2）
  - 启动 sing-box（Docker，host network）
  - 调用 `POST /api/internal/register-node` 向面板注册多条节点记录（每个协议一条）
  - 创建并启动 `panel-singbox-connector.service`：定时拉取允许 UUID 列表，写回 sing-box 入站 users 并重启容器，实现“到期/封禁/超流量立即断网”（同步间隔可通过脚本参数 `--interval` 控制）

### 10.11 Xray gRPC 热更新（无需重启，接近 XBoard/XrayR 体验）

> 当你强需求“增删用户无需重启、立刻生效”，推荐使用 Xray 的 gRPC `HandlerService` 动态 `AddUser/RemoveUser`。  
> 本项目采用“自写 node-daemon（复用 connector）”对接你现有的 `/api/internal/*`，而不是强行做 V2Board/XBoard 兼容层。

- 新增一键脚本（Xray 二进制 + systemd）：`oneclick/ubuntu-xray-reality-grpc-oneclick.sh`
  - 自动安装/重装 Xray（可重跑覆盖旧服务）
  - 生成 Reality keypair + shortId
  - 写入 `/etc/xray/config.json`：VLESS Reality inbound tag 固定为 `in-vless-reality`，并启用 `api.listen=127.0.0.1:10085` + `HandlerService`
  - 调用 `POST /api/internal/register-node` 注册节点并拿到 `node_id`
  - 自动拉仓库并 `go build` connector，启动 `panel-xray-daemon.service`（`APPLY_MODE=xray-grpc`，`XRAY_TAG_MAP=<node_id>:in-vless-reality`）
- 节点本机按键面板：`oneclick/tools/xray-panel.sh`（脚本也会安装到节点机 `${INSTALL_DIR}/tools/xray-panel.sh`）
  - 查看面板允许 UUID（internal API）
  - 查看本机已应用 UUID（`applied.json`）
  - 手动执行一次同步（`connector -once`）
  - 重新注册节点到主面板（register-node）
  - **查询某个 UUID 的流量与状态**：调用 `/api/internal/auth` + `/api/internal/user-traffic`，在节点机一键查看：
    - 该 UUID 是否被允许上网（含拒绝原因：封禁/超流量/无有效套餐等）
    - 用户总配额/已用流量 + 近 24 小时上传/下载统计
- 端口说明：
  - 面板侧：需要让节点能访问到 `http://<panel>:3000`（internal API）
  - 节点侧：Xray gRPC API **仅监听本机** `127.0.0.1:10085`，不要对公网暴露

#### 10.11.3 节点机“一行命令”入口脚本

- 为了减少节点机上的操作步骤，新增总入口脚本：`oneclick/install-xray-node.sh`
  - 功能：在节点机上一行命令完成 apt 更新 + 仓库拉取/更新 + 运行 `ubuntu-xray-reality-grpc-oneclick.sh`
  - 建议使用方式（节点机上执行）：

```bash
curl -fsSL https://raw.githubusercontent.com/396910028/oneclick/master/oneclick/install-xray-node.sh | sudo bash
```

- 脚本内部大致流程：
  - `apt-get update && apt-get install -y git curl ca-certificates`
  - `git clone` 或 `git pull` 当前仓库到 `/opt/panel-node-xray-src`
  - `cd oneclick && bash ubuntu-xray-reality-grpc-oneclick.sh`
  - 结束时提示常用检查命令（`systemctl status panel-xray*`、`xp` 等）

---

## 11. 签到送流量 + 套餐相关设计（DB 层）

- 在 `users` 表中新增字段（已写入 `db_example_basic.sql`）：
  - `last_signin_at`：最后一次签到时间，用于判断当天是否已经签到。
  - `signin_streak`：连续签到天数，用于后续实现“连续签到奖励”等逻辑。
- 新增表 `user_signins`（同样已写入 `db_example_basic.sql`）：
  - 记录用户每日签到记录（`user_id` + `date` 唯一，建有 `uk_user_signins_user_date` 索引）。
  - 字段 `bonus_traffic` 保存本次签到奖励的流量（字节），方便后续统计与追溯。
- **签到套餐设计**：
  - 在 `plan_groups` 中创建"签到套餐"总套餐（`group_key='signin'`, `is_exclusive=0`，可与其他套餐共存）。
  - 在 `plans` 中创建"签到奖励-10分钟"子套餐（`duration_days=1`，`is_public=0`，不在前台展示）。
  - **签到逻辑**：
    - **已有套餐的用户**：查找当前所有有效订单，计算最晚到期时间，创建签到订单延长套餐 **10分钟**（通过设置 `paid_at = 当前到期时间 - (1天 - 10分钟)`，这样 `paid_at + duration_days(1天)` = 当前到期时间 + 10分钟）。
    - **没有套餐的用户**：创建签到订单，`paid_at = NOW() - (1天 - 10分钟)`，`duration_days=1`，这样到期时间 = NOW() + 10分钟，给用户一个10分钟的有效套餐。
  - 流量奖励：每次签到随机赠送 0-100MB 流量，直接累加到 `users.traffic_total`。
- 后端接口：
  - `POST /api/auth/signin`：登录用户每日签到接口，按 **UTC+8 自然日** 重置（通过 JS 计算 UTC+8 日期字符串插入 `user_signins.date`），幂等设计：当天多次调用只会返回同一条记录。返回数据包含 `planExtended`（是否延长了套餐）和 `planCreated`（是否创建了新套餐）。
  - `GET /api/auth/me`：返回字段中已补充 `last_signin_at`、`signin_streak`，便于前端判断“今日是否已签到”与展示连续签到天数。
- 前端扩展：
  - 在总览页 `Dashboard.vue` 中新增“每日签到”卡片，展示规则说明 + “立即签到/今日已签到”按钮。
  - 按钮点击调用 `/api/auth/signin`，成功后更新本地 `traffic_total`、`last_signin_at`、`signin_streak`，并在界面显示“今日获得 X MB 流量（可选：连续签到天数）”。
  - 如果返回 `planExtended` 或 `planCreated`，可以提示用户“套餐已延长10分钟”或“已获得10分钟免费套餐”。

---

## 12. 套餐升级功能（按剩余价值抵扣）

- **后端接口**（`backend/src/routes/orders.js`）：
  - `GET /api/orders/:id/upgrade-preview`：升级预览接口
    - 参数：`new_plan_id`（query）
    - 功能：计算旧套餐剩余价值（按剩余天数比例）、新套餐价格、需补金额
    - 返回：`{ oldOrder, newPlan, oldRemainingValue, needPay }`
    - 校验：新套餐等级必须 > 旧套餐等级；如果需补金额 < 0，返回错误“旧套餐残值超过新套餐价格，请联系客服处理”
  - `POST /api/orders/:id/upgrade-confirm`：确认升级并创建新订单
    - 参数：`new_plan_id`、`pay_method`（body）
    - 功能：再次验证升级条件，创建新订单（金额为需补金额，如果为 0 则免费）
    - 返回：新订单信息（`order_no`、`amount`、`duration_days`、`status='pending'`）
- **前端实现**（`frontend/src/views/plans/PlansList.vue`）：
  - 在套餐列表页面点击“订阅”时，自动判断是否是升级场景：
    - 如果当前有已支付订单（`GET /api/orders/current`）且新套餐等级 > 当前套餐等级，走升级流程
    - 否则走普通下单流程
  - 升级流程：
    1. 调用 `getUpgradePreview` 获取预览信息
    2. 弹窗显示升级确认信息（当前套餐、旧套餐残值、新套餐、需补金额）
    3. 用户确认后调用 `confirmUpgrade` 创建升级订单
  - 升级订单创建成功后，刷新当前订单信息
- **业务规则**：
  - 只能从低等级套餐升级到高等级套餐（`new_level > old_level`）
  - 旧套餐残值 = 原订单金额 ×（剩余天数 / 总天数）
  - 需补金额 = 新套餐价格 - 旧套餐残值
  - 如果需补金额 < 0（残值超过新套餐价格），系统拒绝并提示联系客服
  - 同一套餐的多个订单可以累加时间（按 `paid_at + duration_days` 累加），不同套餐只能升级（不能降级）

---

## 13. 套餐模型变更（单一价格 + 持续时间）

---

## 14. 总套餐/子套餐模型重构（plan_groups + plans）

- **数据库变更**（`db_example_basic.sql`）：
  - 新增表 `plan_groups`（总套餐表）：
    - 字段：`id`, `group_key`（唯一标识，如 basic/pro/vip）, `name`（总套餐名称）, `level`（等级，用于升级判断）, `is_exclusive`（是否互斥）, `status`, `sort_order`
    - 说明：总套餐是一个**集合概念**，不是可购买的套餐，只用于定义等级、互斥规则等。
  - 修改表 `plans`（子套餐表）：
    - 移除字段：`group_key`, `group_name`, `level`, `is_exclusive`（这些信息从所属总套餐继承）
    - 新增字段：`group_id`（外键 → `plan_groups.id`，NOT NULL）
    - 保留字段：`name`（子套餐名称，如"基础套餐-月"）, `price`, `duration_days`, `traffic_limit`, `speed_limit`, `connections` 等
- **后端变更**：
  - 新增总套餐管理接口（`backend/src/routes/admin.js`）：
    - `GET /api/admin/plan-groups`：列出所有总套餐
    - `POST /api/admin/plan-groups`：创建总套餐（需提供 `group_key`, `name`, `level`, `is_exclusive`）
    - `PUT /api/admin/plan-groups/:id`：更新总套餐
    - `DELETE /api/admin/plan-groups/:id`：删除总套餐（需先删除所有子套餐）
  - 修改子套餐管理接口（`backend/src/routes/admin.js`）：
    - `GET /api/admin/plans`：只返回子套餐（JOIN `plan_groups` 获取总套餐信息）
    - `POST /api/admin/plans`：创建子套餐时只需提供 `group_id`（不再需要 `level`/`is_exclusive`，从总套餐继承）
    - `PUT /api/admin/plans/:id`：更新子套餐（可修改 `group_id`，但需验证新总套餐存在且启用）
  - 修改用户端套餐接口（`backend/src/routes/products.js`）：
    - `GET /api/plans`：只返回子套餐（JOIN `plan_groups` 获取总套餐信息，包括 `level`、`is_exclusive`）
  - 修改订单/升级逻辑（`backend/src/routes/orders.js`）：
    - 购买时：从 `plans` JOIN `plan_groups` 获取 `level` 和 `is_exclusive`，用于等级限制和互斥判断
    - 升级时：使用总套餐的 `level` 进行比较（新总套餐等级必须 > 旧总套餐等级）
  - 修改订阅/内部接口（`backend/src/routes/subscription.js`, `internal.js`, `node_agent.js`）：
    - 所有涉及套餐查询的地方，如需 `level`/`is_exclusive`，都改为 JOIN `plan_groups` 获取
    - `getActivePlanIdsForUser` 函数改为使用 `duration_days` 而不是 `period`
- **前端变更**：
  - `AdminPlans.vue` 完全重构：
    - 分为两个独立卡片：**总套餐管理** 和 **子套餐管理**
    - 总套餐管理：
      - 列表显示：ID、总套餐标识、总套餐名称、等级、互斥、排序、状态
      - 创建/编辑表单：`group_key`（唯一标识，编辑时禁用）, `name`, `level`, `is_exclusive`, `sort_order`, `status`
    - 子套餐管理：
      - 列表显示：ID、总套餐名称、子套餐名称、等级（从总套餐继承，只读显示）、价格、时长、流量、设备、上架、状态
      - 创建/编辑表单：
        - **所属总套餐**：下拉选择（`group_id`，必填，只能从已有总套餐中选择）
        - **总套餐名称**：自动显示（只读，从选中的总套餐继承）
        - **等级**：自动显示（只读，从选中的总套餐继承）
        - 其他字段：`name`（子套餐名称）, `description`, `price`, `duration_days`, `traffic_limit`, `speed_limit`, `connections`, `is_public`, `status`
  - `PlansList.vue`（用户端套餐列表）：
    - 无需修改，因为后端 `/api/plans` 已经只返回子套餐
- **业务规则**：
  - **总套餐**：定义等级、互斥规则，不是可购买的套餐
  - **子套餐**：可购买的套餐，必须属于某个总套餐，等级和互斥规则从总套餐继承
  - **互斥判断**：基于总套餐的 `is_exclusive`，同一总套餐下的子套餐可以共存/升级
  - **升级判断**：基于总套餐的 `level`，只能从低等级总套餐升级到高等级总套餐
- **迁移 SQL**：
  - 提供 `migrate_to_plan_groups.sql` 脚本，用于从旧结构迁移到新结构：
    - 创建 `plan_groups` 表
    - 从现有 `plans` 表提取唯一的总套餐信息插入 `plan_groups`
    - 为 `plans` 表添加 `group_id` 字段并填充数据
    - 删除 `plans` 表的 `group_key`, `group_name`, `level`, `is_exclusive` 字段

- **数据库变更**（`db_example_basic.sql`）：
  - `plans` 表：
    - 移除字段：`month_price`、`quarter_price`、`year_price`、`reset_traffic_cycle`
    - 新增字段：`price`（单一价格）、`duration_days`（持续时间，天，默认 30）
  - `orders` 表：
    - 移除字段：`period`（ENUM('month','quarter','year')）
    - 新增字段：`duration_days`（INT，创建订单时从套餐快照写入）
- **后端变更**：
  - `GET /api/admin/plans`、`GET /api/plans`：查询字段改为 `price`、`duration_days`
  - `POST /api/admin/plans`、`PUT /api/admin/plans/:id`：创建/更新套餐时使用 `price` + `duration_days`
  - `POST /api/orders`：创建订单时不再需要 `period`，自动从 `plan.duration_days` 写入 `orders.duration_days`
  - `GET /api/orders/current`：到期时间计算改为按订单 `paid_at + duration_days` 累加（不再使用 `addMonths`）
  - `GET /api/orders/:id/upgrade-preview`、`POST /api/orders/:id/upgrade-confirm`：升级接口改为基于 `duration_days` 计算残值
  - `GET /api/sub/:token`：订阅接口到期时间计算改为按订单 `paid_at + duration_days` 累加
- **前端变更**：
  - `AdminPlans.vue`：表单改为 `price` + `duration_days`，移除月/季/年价格和重置周期字段
  - `PlansList.vue`：去掉周期下拉，直接点击“订阅”购买；升级弹窗显示 `duration_days` 而不是 `period`
  - `OrdersList.vue`、`AdminOrders.vue`：订单列表“周期”列改为“时长（天）”，显示 `duration_days`
  - `Dashboard.vue`：
    - 总览页新增“流量使用统计”卡片：
      - 支持切换“最近 60 分钟 / 最近 24 小时”（`rangeMinutes=60/1440`）
      - 每 1 分钟自动刷新一次数据（前端定时调用 `/api/traffic/history`）
      - 展示总上传/总下载以及分钟级明细表（时间、上传、下载），数据来自 `user_traffic_minute`
- **示例数据**：
  - 示例套餐改为：`基础套餐-月`（30天）、`基础套餐-年`（365天）、`高级套餐-月`（30天）、`高级套餐-年`（365天）
- **业务影响**：
  - 流量为一次性配额，无重置周期（订单到期或流量用完即失效）
  - 套餐名称建议包含时长信息（如“基础套餐-月”、“基础套餐-年”），便于用户区分

#### 10.11.1 一键脚本与 node-daemon 行为补充

- Go 版本 & 依赖：
  - 一键脚本会自动安装/升级 Go（当前使用 go1.25.6），并设置 `GOTOOLCHAIN=local`，避免运行时再自动下载 toolchain。
  - 在编译 `connector` 前自动执行 `go mod tidy` 生成 `go.sum` 并拉取依赖。
- Reality keypair 生成：
  - 优先使用 `xray x25519`，若仅输出 PrivateKey、不含 PublicKey，则自动回退为使用 sing-box 的 `generate reality-keypair`（tar 版失败后再尝试 deb 版）。
- 节点重装/多次运行时总是保持“最新 node_id”：
  - 每次调用 `/api/internal/register-node` 成功后，脚本会重写 `/opt/panel-node-xray/daemon.env` 中的：
    - `NODE_IDS=<新 node_id>`
    - `XRAY_TAG_MAP=<新 node_id>:in-vless-reality`
  - 并重写 `panel-xray-daemon.service`，执行 `systemctl daemon-reload && systemctl enable --now panel-xray-daemon.service`，保证 node-daemon 始终对齐最新节点 ID。
- 节点机快捷命令与按键面板：
  - 安装完成后会在节点机创建快捷命令：`xp` / `xray-panel` / `xr`，均指向 `xray-panel.sh`。
  - 按键面板功能：
    - 1）查看面板允许的 UUID（`allowed-uuids`）
    - 2）查看本机已应用的 UUID（`applied.json`）
    - 3）执行一次同步（`connector -once`）
    - 4）重新注册节点到主面板（重新调用 `/api/internal/register-node`，并自动更新 `daemon.env` + 重启 node-daemon）

#### 10.11.2 订阅链接中的 Reality 参数（VLESS）

- V2Ray 订阅格式（`format=v2ray`）中，VLESS 节点链接会自动包含：
  - `flow=<config.flow>`（通常为 `xtls-rprx-vision`）
  - `security=reality`（或 `tls`）
  - `encryption=none`
  - `sni=<config.sni>`
  - `pbk=<config.publicKey>`（Reality 公钥）
  - `sid=<config.shortId>`（Reality 短 ID，便于客户端自动填入）
  - `fp=chrome`（默认指纹，避免 V2RayN 等客户端报 `empty "fingerprint"`）
- 这样客户端（V2RayN/V2RayNG 等）通过订阅导入时，就能自动拿到完整的 Reality 参数，无需手工补全短 ID 和 fingerprint。

