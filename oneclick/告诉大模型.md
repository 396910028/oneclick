# 一键开局脚本（oneclick）

本目录专门用于存放“新机器一键开局”脚本。

当前提供：

- `ubuntu-xray-vless-reality-oneclick.sh`：Ubuntu 一键部署 **Xray（VLESS + Reality）** + 自动向面板注册节点 + 定时同步允许 UUID 并重启 Xray 生效（用于真正“强行断网”）。
- `ubuntu-singbox-multi-oneclick.sh`：Ubuntu 一键部署 **sing-box 多协议（VLESS Reality / VMess TLS / Trojan TLS / Hy2 TLS / SOCKS5）** + 自动注册到面板 + 定时同步允许 UUID 并重启 sing-box 生效（用于真正“强行断网”）。

## 使用前提

- 面板后端已设置 `INTERNAL_API_KEY`（见 `backend/.env.docker`）
- 面板后端已启用 internal 接口：
  - `POST /api/internal/register-node`
  - `GET /api/internal/nodes/:nodeId/allowed-uuids`

## 一键开局（Ubuntu，Xray）

```bash
sudo bash ubuntu-xray-vless-reality-oneclick.sh
```

## 一键开局（Ubuntu，sing-box 多协议）

```bash
sudo bash ubuntu-singbox-multi-oneclick.sh
```

脚本会提示你选择模式：

- `agent`：面板主动连节点（推荐，本地面板也能用）
- `panel`：节点主动连面板（需要填面板公网地址 + INTERNAL_API_KEY）

## 本地面板/无公网：使用“被控端 node-agent”完成一键绑定

如果你的面板后端只在本地跑（节点机无法访问 `127.0.0.1:3000`），脚本会在节点机上额外启动 `node-agent`：

- 默认端口会按“连续端口”自动分配（起始端口默认 1080，共 6 个端口），其中 `Agent = 起始端口 + 5`。
- 用 `agent token` 保护（请求头：`x-agent-token`）
 - 脚本会尝试自动放行端口段（优先 ufw/firewalld）；云厂商安全组仍需你在控制台放行 `1080-1085`（或你自定义的端口段）。

### 面板一键导入（免复制两次）

`ubuntu-singbox-multi-oneclick.sh` 在 `mode=agent` 时会输出一行「一键导入码」：

- 格式：`SBAGENT1:<base64(json)>`
- 面板侧只需要把这一行粘贴到「节点管理 -> 一键绑定节点」的「一键导入码」，点击解析/导入即可。
- 节点机也会保存到：`${INSTALL_DIR}/agent/agent_import_code`（同时保存 token 到 `${INSTALL_DIR}/agent/agent_token`）

## 常见报错：`container name "/panel_singbox" is already in use`

说明你之前跑过脚本，已有同名容器存在。  
新版脚本默认按起始端口自动设置容器名（例如 `panel_singbox_1080`），并在检测到容器存在时提示是否删除重建。

面板侧（管理员登录）用 API 主动连接节点机完成绑定：

- `POST /api/admin/node-agent/import`
- `POST /api/admin/node-agent/push-uuids`

## 常见报错：`Unable to locate package docker-compose-plugin`

这是 Ubuntu 没启用 Docker 官方仓库时的常见现象。  
脚本已自动兼容：会自动添加 Docker 官方 APT 源并安装 `docker-compose-plugin`；若仍失败，会回退安装 `docker-compose`（v1）并继续执行。

## 常见报错：`xray xray: unknown command`

说明你运行的是旧版脚本，里面用 `docker run <xray镜像> xray x25519` 生成 Reality key，导致实际执行成 `xray xray ...` 报错。  
新版脚本已改为：

- `docker run --rm --entrypoint xray <xray镜像> x25519`

请重新从 GitHub Raw 拉取最新脚本后再执行。

## 常见报错：`Reality key 生成失败：PrivateKey: ...`

这通常是 **xray 输出格式变化** 导致脚本解析不到公钥/私钥。  
新版脚本已改为直接使用：

- `sing-box generate reality-keypair`


## 参数模式（无人值守/脚本化部署）

如果你想在不交互的情况下部署，可以用参数模式：

```bash
sudo bash ubuntu-singbox-multi-oneclick.sh -- \
  --panel "http://你的面板IP或域名:3000" \
  --token "INTERNAL_API_KEY的值" \
  --name  "HK-SB-01" \
  --sni   "www.cloudflare.com"
```

---

## 面板侧需求（给大模型实现用）

以下为面板后端/前端需实现或调整的规范，实现时请按此执行。

### 一、节点允许 UUID 与套餐互斥

**现象**：节点 A 只绑定基本套餐，未绑定高级套餐。管理员把用户从基本升级到高级后，该用户仍然能使用基本套餐的节点（节点机「UUID 状态对比」对节点 A 仍显示面板允许=TRUE）。期望：升级到高级后，用户**只能**使用高级套餐绑定的节点，**不能**再使用基本套餐的节点。

**原因**：`GET /api/internal/nodes/:nodeId/allowed-uuids` 在计算允许使用该节点的 UUID 时，可能把用户所有未过期且已支付的订单都算进去，没有按套餐互斥过滤；或管理员升级时未取消/失效同一互斥组内的旧订单。

**后端需实现：**

1. **allowed-uuids 计算**（`GET /api/internal/nodes/:nodeId/allowed-uuids`）  
   - 通过 `plan_nodes` 得到该节点对应的所有 `plan_id`，订单 JOIN `plans`、`plan_groups` 得到 `plan_group_id`、`is_exclusive`、`level`。  
   - 只考虑 `orders.status = 'paid'` 且未过期（如 `paid_at + duration_days` 仍在有效期内）的订单。  
   - **互斥组内只认一个有效订单（每个用户）**：若节点所属套餐来自 `is_exclusive = 1` 的 `plan_group`，对每个用户在该互斥组内若有多个有效订单，只保留**一个**（取 **`plan_groups.level` 最大**；level 相同则按 `paid_at` 取最新）。再判断该「唯一有效订单」的 `plan_id` 是否在节点对应的 `plan_id` 集合里：在则允许该用户 UUID 进入 allowed-uuids，不在则不允许。  
   - 若节点绑定的套餐所在总套餐 `is_exclusive = 0`，按现有逻辑（该用户有任意有效订单的 plan 包含该节点即可）。  
   - UUID 从 `user_clients` 或现有用户↔UUID 映射取，去重后返回。

2. **管理员升级用户套餐时**  
   - 在创建/支付高级订单的同时，**自动将用户在该互斥组内原有的有效订单**做取消或失效（如 `status = 'cancelled'`），避免同一用户在同一互斥组内有多条有效订单。  
   - 同时保留上述 allowed-uuids 的互斥计算逻辑，防止历史数据导致「两个都有效」。

3. **多订单**  
   - 即允许管理员强制开多个互斥套餐，allowed-uuids 仍应只按「互斥组内一个有效订单（如 level 最高）」计算。

### 二、节点管理的套餐绑定：绑定总套餐

- 节点管理中的「套餐绑定」应绑定**总套餐（plan_group）**，而不是子套餐（plan）。  
- 实现方式二选一或等价：  
  - **方案 A**：新增表 `plan_group_nodes(group_id, node_id)`，节点与 `plan_groups` 多对多；计算 allowed-uuids 时，节点对应的 `plan_id` 集合 = 该节点绑定的所有总套餐下的所有子套餐（`plans` 中 `group_id` 在该节点绑定的 `group_id` 集合内）。  
  - **方案 B**：沿用 `plan_nodes(plan_id, node_id)`，但在管理界面中「绑定套餐」时选择**总套餐**；保存时后端将该总套餐下所有子套餐（`plans` 中 `group_id = 所选 group_id`）与该节点批量写入 `plan_nodes`。  
- 前端节点编辑/创建时，展示总套餐列表（来自 `plan_groups`），多选绑定；不再按子套餐逐个绑定。

### 三、管理员用户详情

- 管理员在**用户列表**中可点击某用户进入**用户详情页**（或抽屉/弹窗）。  
- 详情中需展示（或提供接口供前端展示）：  
  - **注册时间**：`users.created_at`  
  - **当前套餐**：根据用户当前有效订单（已支付且未过期）对应的子套餐/总套餐名称展示  
  - **套餐激活时间**：当前有效订单的 `paid_at` 或约定「激活时间」字段  
  - **账户余额**：`users.balance`  
  - **该用户的分享 URL**：若业务有「邀请/分享链接」，则展示该用户的分享链接  
  - **UUID**：该用户在主出站凭证中的 UUID（来自 `user_clients`，可展示主 UUID 或列表）  
- 后端需提供**单用户详情接口**（如 `GET /api/admin/users/:id` 或已有接口扩展），返回上述字段；前端在用户列表行提供「详情」入口并跳转/打开详情页。

