# 一键开局脚本（oneclick）

本目录专门用于存放“新机器一键开局”脚本。

当前提供：

- `ubuntu-xray-vless-reality-oneclick.sh`：Ubuntu 一键部署 **Xray（VLESS + Reality）** + 自动向面板注册节点 + 定时同步允许 UUID 并重启 Xray 生效（用于真正“强行断网”）。
- `ubuntu-singbox-multi-oneclick.sh`：Ubuntu 一键部署 **sing-box 多协议（VLESS Reality / VMess TLS / Trojan TLS / Hy2 TLS / SOCKS5）** + 自动注册到面板 + 定时同步允许 UUID 并重启 sing-box 生效（用于真正“强行断网”）。

## 使用前提

- 面板后端已设置 `INTERNAL_API_KEY`（见 `backend/.env.docker`）
- 面板后端已启用 internal 接口：
  - `POST /api/internal/register-node`
  - `GET /api/internal/nodes/:nodeId/allowed-uuids`

## 一键开局（Ubuntu，Xray）

```bash
sudo bash ubuntu-xray-vless-reality-oneclick.sh
```

## 一键开局（Ubuntu，sing-box 多协议）

```bash
sudo bash ubuntu-singbox-multi-oneclick.sh
```

脚本会提示你选择模式：

- `agent`：面板主动连节点（推荐，本地面板也能用）
- `panel`：节点主动连面板（需要填面板公网地址 + INTERNAL_API_KEY）

## 本地面板/无公网：使用“被控端 node-agent”完成一键绑定

如果你的面板后端只在本地跑（节点机无法访问 `127.0.0.1:3000`），脚本会在节点机上额外启动 `node-agent`：

- 默认端口会按“连续端口”自动分配（起始端口默认 1080，共 6 个端口），其中 `Agent = 起始端口 + 5`。
- 用 `agent token` 保护（请求头：`x-agent-token`）
 - 脚本会尝试自动放行端口段（优先 ufw/firewalld）；云厂商安全组仍需你在控制台放行 `1080-1085`（或你自定义的端口段）。

### 面板一键导入（免复制两次）

`ubuntu-singbox-multi-oneclick.sh` 在 `mode=agent` 时会输出一行「一键导入码」：

- 格式：`SBAGENT1:<base64(json)>`
- 面板侧只需要把这一行粘贴到「节点管理 -> 一键绑定节点」的「一键导入码」，点击解析/导入即可。
- 节点机也会保存到：`${INSTALL_DIR}/agent/agent_import_code`（同时保存 token 到 `${INSTALL_DIR}/agent/agent_token`）

## 常见报错：`container name "/panel_singbox" is already in use`

说明你之前跑过脚本，已有同名容器存在。  
新版脚本默认按起始端口自动设置容器名（例如 `panel_singbox_1080`），并在检测到容器存在时提示是否删除重建。

面板侧（管理员登录）用 API 主动连接节点机完成绑定：

- `POST /api/admin/node-agent/import`
- `POST /api/admin/node-agent/push-uuids`

## 常见报错：`Unable to locate package docker-compose-plugin`

这是 Ubuntu 没启用 Docker 官方仓库时的常见现象。  
脚本已自动兼容：会自动添加 Docker 官方 APT 源并安装 `docker-compose-plugin`；若仍失败，会回退安装 `docker-compose`（v1）并继续执行。

## 常见报错：`xray xray: unknown command`

说明你运行的是旧版脚本，里面用 `docker run <xray镜像> xray x25519` 生成 Reality key，导致实际执行成 `xray xray ...` 报错。  
新版脚本已改为：

- `docker run --rm --entrypoint xray <xray镜像> x25519`

请重新从 GitHub Raw 拉取最新脚本后再执行。

## 常见报错：`Reality key 生成失败：PrivateKey: ...`

这通常是 **xray 输出格式变化** 导致脚本解析不到公钥/私钥。  
新版脚本已改为直接使用：

- `sing-box generate reality-keypair`


## 参数模式（无人值守/脚本化部署）

如果你想在不交互的情况下部署，可以用参数模式：

```bash
sudo bash ubuntu-singbox-multi-oneclick.sh -- \
  --panel "http://你的面板IP或域名:3000" \
  --token "INTERNAL_API_KEY的值" \
  --name  "HK-SB-01" \
  --sni   "www.cloudflare.com"
```

