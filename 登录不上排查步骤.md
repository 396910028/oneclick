# 登录不上排查步骤

## 1. 确认是「登录接口失败」还是「登录后页面失败」

- **登录接口失败**：点登录后，请求 `POST /api/auth/login` 就返回 4xx/5xx。
- **登录后失败**：登录接口返回 200，但随后跳转总览/个人中心时出错或又回到登录页。

---

## 2. 看后端日志（最重要）

后端在 500 时会打印错误信息，例如：

- 本地运行：看运行后端的终端输出。
- Docker：`docker logs <后端容器名>` 或 `docker compose logs backend`。

**典型错误示例：**

- `ER_BAD_FIELD_ERROR` / `errno 1054`、`Unknown column 'order_type'`  
  → 说明 **orders 表还缺迁移列**，按下面「3. 检查并补全迁移」处理。
- `Unknown column 'connections'`（或 `speed_limit`）  
  → 说明 **plan_groups 表还缺迁移列**，执行 `migrate_plan_groups_connections_speed.sql`。
- `ECONNREFUSED`、`connect ETIMEDOUT`  
  → 数据库连不上，检查数据库是否启动、地址/端口/库名是否正确（如 `.env` 里 `DB_*`）。
- `Access denied for user`  
  → 数据库账号或密码错误。

记下 **完整报错的那一行**（含 `errno`、`sqlMessage`、`sql`），便于进一步查。

---

## 3. 检查并补全迁移（若日志里出现 Unknown column）

在 MySQL 里**先选中你的库**（和 backend 用的库一致），再执行迁移：

```sql
-- 先选中库（库名按你实际修改）
USE ip_proxy_platform;

-- 订单表：若已存在某列会报 Duplicate column，跳过该条即可
ALTER TABLE `orders`
  ADD COLUMN `order_type` VARCHAR(20) NOT NULL DEFAULT 'purchase' COMMENT 'purchase=购买, unsubscribe=管理员退订' AFTER `status`;
ALTER TABLE `orders`
  ADD COLUMN `traffic_amount` BIGINT NOT NULL DEFAULT 0 COMMENT '本单流量(字节)' AFTER `duration_days`;
ALTER TABLE `orders`
  ADD COLUMN `remark` VARCHAR(255) DEFAULT NULL COMMENT '备注' AFTER `traffic_amount`;

-- 总套餐表
ALTER TABLE `plan_groups`
  ADD COLUMN `connections` INT NOT NULL DEFAULT 1 COMMENT '设备数' AFTER `sort_order`;
ALTER TABLE `plan_groups`
  ADD COLUMN `speed_limit` INT NOT NULL DEFAULT 0 COMMENT '限速 Mbps' AFTER `connections`;
```

执行完后**重启后端**，再试登录。

---

## 4. 用接口直接测（不依赖前端）

在命令行用 curl 测（把 `http://localhost:3000` 换成你实际后端地址）：

```bash
# 1）健康检查（数据库是否通）
curl -s http://localhost:3000/api/health

# 2）迁移诊断（是否缺列）
curl -s http://localhost:3000/api/health/db-check

# 3）登录（把 username、password 换成你的账号）
curl -s -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d "{\"username\":\"你的用户名\",\"password\":\"你的密码\"}"
```

- 若 1 返回 `"db":"connected"` 说明数据库通。
- 若 2 返回里有 `orders: ["缺少列: order_type"]` 等，说明要执行上面第 3 步的迁移。
- 若 3 返回 `"code":200` 且带 `token`，说明登录接口正常，问题多半在「登录之后」的请求（见第 5 步）。

---

## 5. 看浏览器里是哪个请求报错（登录后仍失败时）

1. 打开开发者工具（F12）→ **Network（网络）**。
2. 勾选 **Preserve log**（保留日志）。
3. 再操作一次：输入账号密码 → 点登录。
4. 看列表里**第一个变红或状态码 4xx/5xx 的请求**：
   - 若是 `login` → 按第 2 步看后端日志里对应错误。
   - 若是 `current`（总览当前套餐）→ 多半是 orders 表缺列，按第 3 步补迁移。
   - 若是 `me`、`site-config`、`token` 等 → 把该请求的 URL 和状态码、以及后端日志里同一时刻的报错记下来，再按报错查。

---

## 6. 小结

| 现象 | 优先做 |
|------|--------|
| 点登录后一直转圈/无反应 | 看 Network 里 `login` 是否 200；看后端日志是否有 500 报错 |
| 登录后马上又回到登录页或白屏 | 看 Network 里第一个失败的请求（如 `current`）；看后端日志对应报错 |
| 后端日志里有 `Unknown column 'order_type'`（或 traffic_amount/remark） | 在正确库下执行订单表三条 ALTER（见第 3 步） |
| 后端日志里有 `Unknown column 'connections'` 或 `speed_limit` | 在正确库下执行 plan_groups 两条 ALTER（见第 3 步） |
| 后端日志里数据库连接错误 | 检查 DB 是否启动、`.env` 里 `DB_HOST/DB_USER/DB_PASSWORD/DB_DATABASE` |

按上述步骤做完后，若仍登录不上，把 **后端日志里完整一行报错** 和 **Network 里失败请求的 URL + 状态码** 发出来，便于继续排查。
